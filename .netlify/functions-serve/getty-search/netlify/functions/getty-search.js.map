{
  "version": 3,
  "sources": ["../../home/charlieturner/repos/freelance/exhibition-curator/netlify/functions/getty-search.ts"],
  "sourceRoot": "/tmp/tmp-50494-8qIRdhrl3rbN",
  "sourcesContent": ["import type { Handler } from \"@netlify/functions\";\n\nexport const handler: Handler = async (event) => {\n  try {\n    const params = event.queryStringParameters || {};\n    const q       = (params.q ?? \"\").trim();\n    const page    = Math.max(1, parseInt(params.page ?? \"1\", 10));\n    const perPage = Math.min(100, Math.max(1, parseInt(params.perPage ?? \"24\", 10)));\n    const offset  = (page - 1) * perPage;\n\n    const groupURI = params.group?.startsWith(\"http\") ? params.group : \"\";\n\n    const sparql = `\nPREFIX la:  <https://linked.art/ns/terms/>\nPREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>\n\nSELECT ?object ?title ?img WHERE {\n  ?object a la:HumanMadeObject .\n  OPTIONAL { ?object la:digitally_shown_by/la:access_point ?img . }\n  FILTER(BOUND(?img))\n  ${groupURI ? `\n    { ?object la:current_custodian <${groupURI}> . }\n    UNION\n    { ?object crm:P50_has_current_keeper <${groupURI}> . }\n  ` : \"\"}\n  OPTIONAL { ?object la:title ?title . }\n  ${q ? `FILTER(CONTAINS(LCASE(STR(?title)), LCASE(\"${escapeSparqlLiteral(q)}\")))` : \"\"}\n}\nORDER BY LCASE(STR(?title))\nLIMIT ${perPage}\nOFFSET ${offset}\n`.trim();\n\n    const endpoint = process.env.GETTY_SPARQL_ENDPOINT\n      ?? \"https://data.getty.edu/museum/collection/sparql\";\n\n    const r = await fetch(endpoint, {\n      method: \"POST\",\n      headers: {\n        \"accept\": \"application/sparql-results+json\",\n        \"content-type\": \"application/sparql-query\",\n        // \"x-api-key\": process.env.GETTY_API_KEY!   // if required\n      },\n      body: sparql,\n    });\n\n    if (!r.ok) return { statusCode: 502, body: `SPARQL error ${r.status}` };\n\n    const data = await r.json();\n    const items = (data.results?.bindings ?? []).map((b: any) => ({\n      id: b.object?.value,\n      title: b.title?.value ?? \"(untitled)\",\n      imageUrl: b.img?.value ?? null,\n    }));\n\n    return {\n      statusCode: 200,\n      headers: {\n        \"content-type\": \"application/json\",\n        \"cache-control\": \"public, max-age=120\"\n      },\n      body: JSON.stringify({ page, perPage, count: items.length, items }),\n    };\n  } catch (e: any) {\n    return { statusCode: 500, body: e?.message ?? \"Server error\" };\n  }\n};\n\nfunction escapeSparqlLiteral(s: string) {\n  return s.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"');\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEO,IAAM,UAAmB,OAAO,UAAU;AAC/C,MAAI;AACF,UAAM,SAAS,MAAM,yBAAyB,CAAC;AAC/C,UAAM,KAAW,OAAO,KAAK,IAAI,KAAK;AACtC,UAAM,OAAU,KAAK,IAAI,GAAG,SAAS,OAAO,QAAQ,KAAK,EAAE,CAAC;AAC5D,UAAM,UAAU,KAAK,IAAI,KAAK,KAAK,IAAI,GAAG,SAAS,OAAO,WAAW,MAAM,EAAE,CAAC,CAAC;AAC/E,UAAM,UAAW,OAAO,KAAK;AAE7B,UAAM,WAAW,OAAO,OAAO,WAAW,MAAM,IAAI,OAAO,QAAQ;AAEnE,UAAM,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAQf,WAAW;AAAA,sCACuB,QAAQ;AAAA;AAAA,4CAEF,QAAQ;AAAA,MAC9C,EAAE;AAAA;AAAA,IAEJ,IAAI,8CAA8C,oBAAoB,CAAC,CAAC,SAAS,EAAE;AAAA;AAAA;AAAA,QAG/E,OAAO;AAAA,SACN,MAAM;AAAA,EACb,KAAK;AAEH,UAAM,WAAW,QAAQ,IAAI,yBACxB;AAEL,UAAM,IAAI,MAAM,MAAM,UAAU;AAAA,MAC9B,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,UAAU;AAAA,QACV,gBAAgB;AAAA;AAAA,MAElB;AAAA,MACA,MAAM;AAAA,IACR,CAAC;AAED,QAAI,CAAC,EAAE,GAAI,QAAO,EAAE,YAAY,KAAK,MAAM,gBAAgB,EAAE,MAAM,GAAG;AAEtE,UAAM,OAAO,MAAM,EAAE,KAAK;AAC1B,UAAM,SAAS,KAAK,SAAS,YAAY,CAAC,GAAG,IAAI,CAAC,OAAY;AAAA,MAC5D,IAAI,EAAE,QAAQ;AAAA,MACd,OAAO,EAAE,OAAO,SAAS;AAAA,MACzB,UAAU,EAAE,KAAK,SAAS;AAAA,IAC5B,EAAE;AAEF,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,iBAAiB;AAAA,MACnB;AAAA,MACA,MAAM,KAAK,UAAU,EAAE,MAAM,SAAS,OAAO,MAAM,QAAQ,MAAM,CAAC;AAAA,IACpE;AAAA,EACF,SAAS,GAAQ;AACf,WAAO,EAAE,YAAY,KAAK,MAAM,GAAG,WAAW,eAAe;AAAA,EAC/D;AACF;AAEA,SAAS,oBAAoB,GAAW;AACtC,SAAO,EAAE,QAAQ,OAAO,MAAM,EAAE,QAAQ,MAAM,KAAK;AACrD;",
  "names": []
}
