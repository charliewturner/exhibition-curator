{
  "version": 3,
  "sources": ["../../home/charlieturner/repos/freelance/exhibition-curator/netlify/functions/getty-search.js"],
  "sourceRoot": "/tmp/tmp-69785-1TeJ8Mkqaf4R",
  "sourcesContent": ["export const handler = async (event) => {\n  try {\n    const params = event.queryStringParameters || {};\n    const q = (params.q || \"\").trim();\n    const page = Math.max(1, parseInt(params.page || \"1\", 10));\n    const perPage = Math.min(\n      100,\n      Math.max(1, parseInt(params.perPage || \"24\", 10))\n    );\n    const offset = (page - 1) * perPage;\n\n    const groupURI =\n      params.group && params.group.startsWith(\"http\") ? params.group : \"\";\n\n    const sparql = `\nPREFIX la:  <https://linked.art/ns/terms/>\nPREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>\n\nSELECT ?object ?title ?img WHERE {\n  ?object a la:HumanMadeObject .\n\n  # Must have a digital object with an access point (image)\n  ?object la:digitally_shown_by ?dig .\n  ?dig a la:DigitalObject .\n  ?dig la:access_point ?img .\n\n  # If a group is provided, accept ANY relation from object -> group.\n  ${groupURI ? `?object ?anyRel <${groupURI}> .` : \"\"}\n\n  OPTIONAL { ?object la:title ?title . }\n\n  ${\n    q\n      ? `FILTER(CONTAINS(LCASE(STR(?title)), LCASE(\"${escapeSparqlLiteral(\n          q\n        )}\")))`\n      : \"\"\n  }\n}\nORDER BY LCASE(STR(?title))\nLIMIT ${perPage}\nOFFSET ${offset}\n`.trim();\n\n    const endpoint =\n      process.env.GETTY_SPARQL_ENDPOINT ||\n      \"https://data.getty.edu/museum/collection/sparql\";\n\n    const resp = await fetch(endpoint, {\n      method: \"POST\",\n      headers: {\n        accept: \"application/sparql-results+json\",\n        \"content-type\": \"application/sparql-query\",\n      },\n      body: sparql,\n    });\n\n    if (!resp.ok) {\n      const text = await resp.text().catch(() => \"\");\n      console.error(\"SPARQL error\", resp.status, text);\n      return { statusCode: 502, body: `SPARQL error ${resp.status}` };\n    }\n\n    const json = await resp.json();\n    const items = (json.results?.bindings || []).map((b) => ({\n      id: b.object?.value,\n      title: b.title?.value || \"(untitled)\",\n      imageUrl: b.img?.value || null,\n    }));\n\n    return {\n      statusCode: 200,\n      headers: {\n        \"content-type\": \"application/json\",\n        \"cache-control\": \"public, max-age=120\",\n      },\n      body: JSON.stringify({ page, perPage, count: items.length, items }),\n    };\n  } catch (e) {\n    console.error(\"Function error:\", e);\n    return { statusCode: 500, body: e?.message || \"Server error\" };\n  }\n};\n\nfunction escapeSparqlLiteral(s) {\n  return s.replace(/\\\\/g, \"\\\\\\\\\").replace(/\"/g, '\\\\\"');\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAO,IAAM,UAAU,OAAO,UAAU;AACtC,MAAI;AACF,UAAM,SAAS,MAAM,yBAAyB,CAAC;AAC/C,UAAM,KAAK,OAAO,KAAK,IAAI,KAAK;AAChC,UAAM,OAAO,KAAK,IAAI,GAAG,SAAS,OAAO,QAAQ,KAAK,EAAE,CAAC;AACzD,UAAM,UAAU,KAAK;AAAA,MACnB;AAAA,MACA,KAAK,IAAI,GAAG,SAAS,OAAO,WAAW,MAAM,EAAE,CAAC;AAAA,IAClD;AACA,UAAM,UAAU,OAAO,KAAK;AAE5B,UAAM,WACJ,OAAO,SAAS,OAAO,MAAM,WAAW,MAAM,IAAI,OAAO,QAAQ;AAEnE,UAAM,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAaf,WAAW,oBAAoB,QAAQ,QAAQ,EAAE;AAAA;AAAA;AAAA;AAAA,IAKjD,IACI,8CAA8C;AAAA,MAC5C;AAAA,IACF,CAAC,SACD,EACN;AAAA;AAAA;AAAA,QAGM,OAAO;AAAA,SACN,MAAM;AAAA,EACb,KAAK;AAEH,UAAM,WACJ,QAAQ,IAAI,yBACZ;AAEF,UAAM,OAAO,MAAM,MAAM,UAAU;AAAA,MACjC,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,QAAQ;AAAA,QACR,gBAAgB;AAAA,MAClB;AAAA,MACA,MAAM;AAAA,IACR,CAAC;AAED,QAAI,CAAC,KAAK,IAAI;AACZ,YAAM,OAAO,MAAM,KAAK,KAAK,EAAE,MAAM,MAAM,EAAE;AAC7C,cAAQ,MAAM,gBAAgB,KAAK,QAAQ,IAAI;AAC/C,aAAO,EAAE,YAAY,KAAK,MAAM,gBAAgB,KAAK,MAAM,GAAG;AAAA,IAChE;AAEA,UAAM,OAAO,MAAM,KAAK,KAAK;AAC7B,UAAM,SAAS,KAAK,SAAS,YAAY,CAAC,GAAG,IAAI,CAAC,OAAO;AAAA,MACvD,IAAI,EAAE,QAAQ;AAAA,MACd,OAAO,EAAE,OAAO,SAAS;AAAA,MACzB,UAAU,EAAE,KAAK,SAAS;AAAA,IAC5B,EAAE;AAEF,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,iBAAiB;AAAA,MACnB;AAAA,MACA,MAAM,KAAK,UAAU,EAAE,MAAM,SAAS,OAAO,MAAM,QAAQ,MAAM,CAAC;AAAA,IACpE;AAAA,EACF,SAAS,GAAG;AACV,YAAQ,MAAM,mBAAmB,CAAC;AAClC,WAAO,EAAE,YAAY,KAAK,MAAM,GAAG,WAAW,eAAe;AAAA,EAC/D;AACF;AAEA,SAAS,oBAAoB,GAAG;AAC9B,SAAO,EAAE,QAAQ,OAAO,MAAM,EAAE,QAAQ,MAAM,KAAK;AACrD;",
  "names": []
}
